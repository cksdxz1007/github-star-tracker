"""AIåˆ†ææ¨¡å—"""
import pandas as pd
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_core.output_parsers import StrOutputParser
from config.settings import Settings


class AIAnalyzer:
    """AIåˆ†æå™¨"""

    def __init__(self, settings: Settings):
        self.settings = settings
        self.llm = ChatOpenAI(
            model_name=settings.llm_model_name,
            temperature=0.6,
            openai_api_key=settings.openai_api_key,
            openai_api_base=settings.openai_api_base
        )

    def analyze(self, df: pd.DataFrame) -> str:
        """åˆ†æä»“åº“æ•°æ®å¹¶ç”ŸæˆæŠ¥å‘Š"""
        # æ„å»ºåˆ†æä¸Šä¸‹æ–‡
        total_count = len(df)

        # æŒ‰çŠ¶æ€åˆ†ç±»
        archived_count = len(df[df['ä»“åº“çŠ¶æ€'].str.contains('å·²å½’æ¡£', na=False)])
        disabled_count = len(df[df['ä»“åº“çŠ¶æ€'].str.contains('å·²ç¦ç”¨', na=False)])

        # æŒ‰æ›´æ–°æ—¶é—´åˆ†ç±»
        active_recent = len(df[(df['æ²‰å¯‚å¤©æ•°'] >= 0) & (df['æ²‰å¯‚å¤©æ•°'] < 180)])
        inactive_half_yr = len(df[(df['æ²‰å¯‚å¤©æ•°'] >= 180) & (df['æ²‰å¯‚å¤©æ•°'] <= 365)])
        inactive_1yr = len(df[df['æ²‰å¯‚å¤©æ•°'] > 365])

        # é€‰å–å·²å½’æ¡£é¡¹ç›® Top 5ï¼ˆé«˜é£é™©ï¼‰
        archived_projects = df[df['ä»“åº“çŠ¶æ€'].str.contains('å·²å½’æ¡£', na=False)].sort_values("Staræ•°", ascending=False).head(5)
        archived_str = "\n".join(
            [f"- [{row['ä»“åº“å']}]({row['ä»“åº“é“¾æ¥']}) - [{row['ç¼–ç¨‹è¯­è¨€']}] - {row['é¡¹ç›®æè¿°']}\n  âš ï¸ é¡¹ç›®å·²å½’æ¡£ï¼Œå»ºè®®ç«‹å³åˆ¶å®šè¿ç§»è®¡åˆ’ (Star: {row['Staræ•°']}, Fork: {row['Forkæ•°']})"
             for _, row in archived_projects.iterrows()]
        ) if not archived_projects.empty else "æ— å·²å½’æ¡£é¡¹ç›®"

        # é€‰å–è¿‘æœŸæ´»è·ƒé¡¹ç›®ï¼ˆ<180å¤©ï¼‰Top 5
        top_active = df[df['æ²‰å¯‚å¤©æ•°'] < 180].sort_values("å…³æ³¨è€…æ•°", ascending=False).head(5)
        active_str = "\n".join(
            [f"- [{row['ä»“åº“å']}]({row['ä»“åº“é“¾æ¥']}) - [{row['ç¼–ç¨‹è¯­è¨€']}] - {row['é¡¹ç›®æè¿°']}\n  æ›´æ–°äº{row['æœ€è¿‘æ›´æ–°æ—¥æœŸ']}ï¼Œæ›´æ–°å†…å®¹: {row['æœ€è¿‘æ›´æ–°å†…å®¹']} (å…³æ³¨è€…: {row['å…³æ³¨è€…æ•°']}, Issues: {row['å¼€æ”¾Issues']})"
             for _, row in top_active.iterrows()]
        )

        # é€‰å–æ²‰å¯‚åŠå¹´åˆ°ä¸€å¹´çš„é¡¹ç›® Top 5
        half_yr_projects = df[(df['æ²‰å¯‚å¤©æ•°'] >= 180) & (df['æ²‰å¯‚å¤©æ•°'] <= 365)].sort_values("Staræ•°", ascending=False).head(5)
        half_yr_str = "\n".join(
            [f"- [{row['ä»“åº“å']}]({row['ä»“åº“é“¾æ¥']}) - [{row['ç¼–ç¨‹è¯­è¨€']}] - {row['é¡¹ç›®æè¿°']}\n  å·²åœæ›´{row['æ²‰å¯‚å¤©æ•°']}å¤© (Star: {row['Staræ•°']}, å…³æ³¨è€…: {row['å…³æ³¨è€…æ•°']}, Issues: {row['å¼€æ”¾Issues']}, æ ‡ç­¾: {row['é¡¹ç›®æ ‡ç­¾']})"
             for _, row in half_yr_projects.iterrows()]
        )

        # é€‰å–è¶…è¿‡ä¸€å¹´çš„é¡¹ç›® Top 5
        dead_giants = df[df['æ²‰å¯‚å¤©æ•°'] > 365].sort_values("Staræ•°", ascending=False).head(5)
        dead_str = "\n".join(
            [f"- [{row['ä»“åº“å']}]({row['ä»“åº“é“¾æ¥']}) - [{row['ç¼–ç¨‹è¯­è¨€']}] - {row['é¡¹ç›®æè¿°']}\n  ğŸš¨ å·²åœæ›´{row['æ²‰å¯‚å¤©æ•°']}å¤© (Star: {row['Staræ•°']}, å…³æ³¨è€…: {row['å…³æ³¨è€…æ•°']}, Fork: {row['Forkæ•°']}, é¡¹ç›®å¹´é¾„: {row['é¡¹ç›®å¹´é¾„']}, æ ‡ç­¾: {row['é¡¹ç›®æ ‡ç­¾']})"
             for _, row in dead_giants.iterrows()]
        )

        # æ„å»ºåˆ†ææç¤º
        template = """
        ä½ æ˜¯ä¸€åæŠ€æœ¯èµ„äº§ç®¡ç†ä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„ GitHub Star æ•°æ®ç”Ÿæˆä¸€ä»½è¯¦ç»†çš„åˆ†ææŠ¥å‘Šã€‚

        ã€æ•°æ®æ¦‚è§ˆã€‘
        - å…³æ³¨é¡¹ç›®æ€»æ•°: {total_count}
        - å·²å½’æ¡£é¡¹ç›®: {archived_count} âš ï¸ é«˜é£é™©
        - ç¦ç”¨é¡¹ç›®: {disabled_count} ğŸš¨ æé«˜é£é™©
        - æ´»è·ƒé¡¹ç›®(è¿‘6ä¸ªæœˆå†…æœ‰æ›´æ–°): {active_recent}
        - æ²‰å¯‚é¡¹ç›®(6ä¸ªæœˆ-1å¹´æœªæ›´æ–°): {inactive_half_yr}
        - é•¿æœŸæ²‰å¯‚é¡¹ç›®(è¶…è¿‡1å¹´æœªæ›´æ–°): {inactive_1yr}

        ã€å·²å½’æ¡£é¡¹ç›® - ç«‹å³è¡ŒåŠ¨ã€‘
        {archived_str}

        ã€è¿‘æœŸæ´»è·ƒé¡¹ç›® (è¿‘6ä¸ªæœˆå†…æœ‰æ›´æ–°)ã€‘
        {active_str}

        ã€æ²‰å¯‚é¡¹ç›® (6ä¸ªæœˆ-1å¹´æœªæ›´æ–°) - éœ€å…³æ³¨ã€‘
        {half_yr_str}

        ã€é•¿æœŸæ²‰å¯‚é¡¹ç›® (è¶…è¿‡1å¹´æœªæ›´æ–°) - é«˜é£é™©ã€‘
        {dead_str}

        ã€ä»»åŠ¡ã€‘
        è¯·ç”Ÿæˆä¸€ä»½ Markdown æ ¼å¼çš„è¯¦ç»†åˆ†ææŠ¥å‘Šï¼ŒåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š

        1. ã€æ•´ä½“å¥åº·åº¦è¯„ä¼°ã€‘
           - ç»™å‡ºå…³äºç”¨æˆ·å…³æ³¨æŠ€æœ¯æ ˆçš„æ•´ä½“å¥åº·åº¦è¯„åˆ†ï¼ˆ0-10åˆ†ï¼‰å’Œç®€çŸ­è¯„ä»·
           - åˆ†ææ´»è·ƒé¡¹ç›®å æ¯”å’Œé£é™©é¡¹ç›®å æ¯”
           - ç‰¹åˆ«è¯„ä¼°å·²å½’æ¡£å’Œç¦ç”¨é¡¹ç›®çš„å½±å“

        2. ã€å·²å½’æ¡£é¡¹ç›®è¯„ä¼° - ç«‹å³å¤„ç†ã€‘
           - å·²å½’æ¡£é¡¹ç›®æ˜¯ç»´æŠ¤è€…è®¤ä¸ºå·²ç»“æŸçš„é¡¹ç›®ï¼Œéœ€è¦ç«‹å³åˆ¶å®šè¿ç§»è®¡åˆ’
           - ä¸ºæ¯ä¸ªå·²å½’æ¡£é¡¹ç›®æä¾›æ›¿ä»£æ–¹æ¡ˆå»ºè®®
           - è¯„ä¼°è¿™äº›é¡¹ç›®åœç”¨å¯¹ä½ çš„å½±å“

        3. ã€æ´»è·ƒé¡¹ç›®åˆ†æã€‘
           - å¯¹æ¯ä¸ª"è¿‘æœŸæ´»è·ƒé¡¹ç›®"ï¼Œæ ¹æ®å…¶ç¼–ç¨‹è¯­è¨€ã€é¡¹ç›®æè¿°å’Œæ ‡ç­¾åˆ¤æ–­é¡¹ç›®ç±»å‹
           - å¯¹å…¶æ›´æ–°å†…å®¹è¿›è¡ŒæŠ€æœ¯è§£è¯»ï¼ˆæ¨æµ‹æ˜¯åœ¨ä¿®Bugã€å‘æ–°ç‰ˆã€åŠŸèƒ½è¿­ä»£ç­‰ï¼‰
           - è¯„ä¼°è¿™äº›é¡¹ç›®åœ¨ä½ å·¥ä½œæµä¸­çš„æ½œåœ¨ä»·å€¼å’Œä¾èµ–é£é™©

        4. ã€æ²‰å¯‚é¡¹ç›®åˆ†æ (6ä¸ªæœˆ-1å¹´æœªæ›´æ–°)ã€‘
           - æ ¹æ®é¡¹ç›®æ ‡ç­¾å’Œæè¿°åˆ†æé¡¹ç›®ç±»å‹ï¼ˆå·¥å…·ç±»ã€åº“ç±»ã€åº”ç”¨ç±»ç­‰ï¼‰
           - è¯„ä¼°ä¸åŒç±»å‹é¡¹ç›®çš„åˆç†æ²‰å¯‚æœŸï¼ˆå·¥å…·ç±»å¯å®¹å¿æ›´é•¿æ—¶é—´ä¸æ›´æ–°ï¼‰
           - è¯„ä¼°é¡¹ç›®æ˜¯å¦ä»æœ‰ä½¿ç”¨ä»·å€¼å’Œå®‰å…¨æ€§
           - æä¾›å…·ä½“å»ºè®®ï¼šæ˜¯å¦éœ€è¦å¯»æ‰¾æ›¿ä»£å“ã€æ˜¯å¦å¯ä»¥ç»§ç»­ä½¿ç”¨ã€æˆ–éœ€è¦è¿ç§»
           - ç‰¹åˆ«å…³æ³¨é«˜Staræ•°å’Œé«˜å…³æ³¨è€…æ•°çš„é¡¹ç›®

        5. ã€é•¿æœŸæ²‰å¯‚é¡¹ç›®åˆ†æ (è¶…è¿‡1å¹´æœªæ›´æ–°) - é«˜é£é™©è¯„ä¼°ã€‘
           - å¯¹è¿™äº›é¡¹ç›®è¿›è¡Œæ·±åº¦åˆ†æï¼Œè€ƒè™‘é¡¹ç›®å¹´é¾„åˆ¤æ–­æ˜¯"ç¨³å®šæˆç†Ÿ"è¿˜æ˜¯"åºŸå¼ƒ"
           - è¯„ä¼°å®‰å…¨é£é™©ï¼ˆæ¼æ´æœªä¿®å¤ï¼‰å’ŒæŠ€æœ¯å€ºåŠ¡
           - å¼ºçƒˆå»ºè®®å¯»æ‰¾æ›¿ä»£å“æˆ–åˆ¶å®šè¿ç§»è®¡åˆ’
           - è¯´æ˜å¦‚æœè¿™äº›é¡¹ç›®å¯¹ä½ çš„å·¥ä½œå¾ˆé‡è¦ï¼Œåº”è¯¥é‡‡å–ä»€ä¹ˆæªæ–½ï¼ˆForké¡¹ç›®ã€å¯»æ‰¾æ›¿ä»£ã€è”ç³»ç»´æŠ¤è€…ç­‰ï¼‰

        6. ã€ç¤¾åŒºæ´»è·ƒåº¦åˆ†æã€‘
           - åˆ†æå…³æ³¨è€…vsStaræ¯”ç‡ï¼Œè¯„ä¼°çœŸå®å…³æ³¨åº¦
           - åˆ†æForkæ•°é‡ï¼Œè¯„ä¼°ç¤¾åŒºå‚ä¸åº¦å’Œæ›¿ä»£æ–¹æ¡ˆå¯å¾—æ€§
           - åˆ†æå¼€æ”¾Issuesæ•°é‡ï¼Œè¯„ä¼°é¡¹ç›®ç»´æŠ¤è´Ÿè½½

        7. ã€è¡ŒåŠ¨è®¡åˆ’å»ºè®®ã€‘
           - æŒ‰é£é™©ç­‰çº§æ•´ç†ä¼˜å…ˆçº§æ¸…å•ï¼šå·²å½’æ¡£ > ç¦ç”¨ > é•¿æœŸæ²‰å¯‚ > æ²‰å¯‚ > æ´»è·ƒ
           - ä¸ºæ¯ä¸ªç±»åˆ«æä¾›å…·ä½“çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®
           - ç»™å‡ºæ—¶é—´å»ºè®®ï¼ˆç«‹å³ã€1å‘¨å†…ã€1ä¸ªæœˆå†…ç­‰ï¼‰

        è¦æ±‚ï¼š
        - ä¿æŒè¯­æ°”ä¸“ä¸šã€å®¢è§‚ä½†ç´§è¿«
        - æ¯ä¸ªå»ºè®®éƒ½è¦å…·ä½“å¯è¡Œï¼ŒåŒ…å«å…·ä½“æ“ä½œæ­¥éª¤
        - é‡ç‚¹å…³æ³¨å®‰å…¨å’Œé•¿æœŸç»´æŠ¤æ€§é—®é¢˜
        - ç‰¹åˆ«æ ‡æ³¨é«˜é£é™©é¡¹ç›®å¹¶ç»™å‡ºç´§æ€¥è¡ŒåŠ¨å»ºè®®
        - åœ¨åˆ†æä¸­å……åˆ†åˆ©ç”¨é¡¹ç›®æ ‡ç­¾ä¿¡æ¯åˆ¤æ–­é¡¹ç›®ç±»å‹å’Œç”¨é€”
        """

        prompt = PromptTemplate.from_template(template)

        # æ‰§è¡Œåˆ†æ
        chain = prompt | self.llm | StrOutputParser()

        return chain.invoke({
            "total_count": total_count,
            "archived_count": archived_count,
            "disabled_count": disabled_count,
            "active_recent": active_recent,
            "inactive_half_yr": inactive_half_yr,
            "inactive_1yr": inactive_1yr,
            "archived_str": archived_str,
            "active_str": active_str,
            "half_yr_str": half_yr_str,
            "dead_str": dead_str
        })
